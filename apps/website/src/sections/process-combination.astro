---
import LayerViz from "../components/layer-viz.astro";
import { LuBriefcaseBusiness, LuCode, LuDatabase } from "react-icons/lu";
---

<section
    id="layers"
    class="relative mx-auto max-w-7xl px-4 py-28 lg:px-8 mb-6"
    data-c1="hsl(0 100% 63% / .10)"
    data-c2="hsl(262 100% 63% / .10)"
>
    <!-- soft grid bg -->
    <div aria-hidden="true" class="pointer-events-none absolute inset-0">
        <div
            class="absolute inset-0 bg-[linear-gradient(to_right,theme(colors.muted.DEFAULT/.12)_1px,transparent_1px),linear-gradient(to_bottom,theme(colors.muted.DEFAULT/.12)_1px,transparent_1px)] bg-[size:36px_36px]"
        >
        </div>
    </div>

    <div class="relative z-10">
        <div class="mx-auto max-w-4xl text-center">
            <div
                class="inline-flex items-center gap-2 rounded-full border border-indigo-500/20 bg-indigo-500/10 backdrop-blur-sm px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 mb-6"
            >
                <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse">
                </div>
                One flow, many views
            </div>
            <h2
                class="text-4xl font-bold sm:text-5xl lg:text-6xl bg-gradient-to-r from-foreground via-indigo-500 to-cyan-500 bg-clip-text text-transparent"
            >
                One process, seen three ways
            </h2>
            <p class="mt-6 text-lg text-muted-foreground max-w-3xl mx-auto">
                People think in steps. Systems run on data. IT cares about
                logic. Flow-Like shows all three together, so every role sees
                the same truth — just in their own language.
            </p>
        </div>

        <!-- STAGE -->
        <div class="mx-auto mt-16 max-w-6xl">
            <div
                class="stage rounded-3xl border border-border/40 bg-card/40 backdrop-blur-sm overflow-hidden"
            >
                <!-- tabs -->
                <div
                    id="layers-tabs"
                    role="tablist"
                    aria-label="Layer views"
                    class="relative flex items-center justify-around gap-1 p-1 sm:grid sm:grid-cols-3 sm:gap-2 sm:p-3"
                >
                    <!-- desktop indicator (hidden on mobile via CSS below) -->
                    <span
                        id="tab-indicator"
                        class="absolute top-3 left-3 h-[calc(100%-24px)] rounded-2xl border border-border/60 bg-muted/60 backdrop-blur-sm transition-[transform,width] duration-300 ease-out will-change-transform pointer-events-none hidden sm:block"
                    ></span>

                    <button
                        id="tab-business"
                        role="tab"
                        aria-controls="panel-business"
                        aria-selected="true"
                        data-target="business"
                        class="layers-tab relative z-10 rounded-2xl px-2.5 py-2 text-xs font-semibold sm:px-4 sm:py-3 sm:text-sm flex-1"
                    >
                        <span
                            class="flex items-center justify-center sm:justify-center gap-1.5 sm:gap-2"
                        >
                            <span
                                data-icon
                                class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-500"
                            >
                                <LuBriefcaseBusiness
                                    className="w-4 h-4 text-white"
                                />
                            </span>
                            <span class="tab-label">Process</span>
                        </span>
                    </button>

                    <button
                        id="tab-data"
                        role="tab"
                        aria-controls="panel-data"
                        aria-selected="false"
                        data-target="data"
                        class="layers-tab relative z-10 rounded-2xl px-2.5 py-2 text-xs font-semibold sm:px-4 sm:py-3 sm:text-sm flex-1"
                    >
                        <span
                            class="flex items-center justify-center sm:justify-center gap-1.5 sm:gap-2"
                        >
                            <span
                                data-icon
                                class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-500 to-cyan-500"
                            >
                                <LuDatabase className="w-4 h-4 text-white" />
                            </span>
                            <span class="tab-label">Data</span>
                        </span>
                    </button>

                    <button
                        id="tab-impl"
                        role="tab"
                        aria-controls="panel-impl"
                        aria-selected="false"
                        data-target="impl"
                        class="layers-tab relative z-10 rounded-2xl px-2.5 py-2 text-xs font-semibold sm:px-4 sm:py-3 sm:text-sm flex-1 mr-4! sm:mr-0"
                    >
                        <span
                            class="flex items-center justify-center sm:justify-center gap-1.5 sm:gap-2"
                        >
                            <span
                                data-icon
                                class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center bg-gradient-to-br from-green-500 to-emerald-500"
                            >
                                <LuCode className="w-4 h-4 text-white" />
                            </span>
                            <span class="tab-label">Execution</span>
                        </span>
                    </button>
                </div>

                <!-- grid: (mobile: panels first, viz second) -->
                <div
                    class="grid lg:grid-cols-[1fr_0.9fr] gap-0 border-t border-border/40"
                >
                    <!-- VIZ -->
                    <div class="relative p-4 lg:p-6 order-2 lg:order-1">
                        <div
                            class="h-[38vh] min-h-[220px] md:h-[min(56vh,520px)] md:min-h-[360px]"
                        >
                            <LayerViz />
                        </div>
                    </div>

                    <!-- PANELS -->
                    <div class="relative p-4 lg:p-6 order-1 lg:order-2">
                        <div
                            id="layers-panels"
                            class="relative md:h-[min(56vh,520px)] md:min-h-[360px]"
                        >
                            <!-- Process -->
                            <article
                                id="panel-business"
                                role="tabpanel"
                                aria-labelledby="tab-business"
                                aria-hidden="false"
                                class="panel data-[state=active]:opacity-100 data-[state=active]:translate-y-0"
                            >
                                <h3 class="text-xl font-bold mb-2">
                                    Process view
                                </h3>
                                <p
                                    class="text-muted-foreground leading-relaxed"
                                >
                                    The plain-English story of how work gets
                                    done. Who does what, when, and why —
                                    captured as one flow. Great for managers and
                                    business owners to align on the same steps.
                                </p>

                                <div
                                    class="mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"
                                >
                                    <div
                                        class="rounded-xl border border-indigo-500/20 bg-indigo-500/10 p-4"
                                    >
                                        <div
                                            class="mb-1 font-semibold text-indigo-700 dark:text-indigo-300"
                                        >
                                            Steps & Handoffs
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            From intake to outcome, see every
                                            stage of the journey.
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-xl border border-purple-500/20 bg-purple-500/10 p-4"
                                    >
                                        <div
                                            class="mb-1 font-semibold text-purple-700 dark:text-purple-300"
                                        >
                                            Decisions
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            Approvals, gates, and routing made
                                            visible.
                                        </div>
                                    </div>
                                </div>
                            </article>

                            <!-- Data -->
                            <article
                                id="panel-data"
                                role="tabpanel"
                                aria-labelledby="tab-data"
                                aria-hidden="true"
                                class="panel"
                            >
                                <h3 class="text-xl font-bold mb-2">
                                    Data view
                                </h3>
                                <p
                                    class="text-muted-foreground leading-relaxed"
                                >
                                    The information layer: what flows through
                                    the process, where it’s stored, and how it
                                    changes. Perfect for analysts and compliance
                                    teams who need clarity on inputs and
                                    outputs.
                                </p>

                                <div
                                    class="mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"
                                >
                                    <div
                                        class="rounded-xl border border-blue-500/20 bg-blue-500/10 p-4"
                                    >
                                        <div
                                            class="font-semibold text-blue-700 dark:text-blue-300"
                                        >
                                            Before & After
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            Track how each step transforms the
                                            data.
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-xl border border-cyan-500/20 bg-cyan-500/10 p-4"
                                    >
                                        <div
                                            class="font-semibold text-cyan-700 dark:text-cyan-300"
                                        >
                                            Sources & Stores
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            Connect databases, documents, and
                                            APIs in one place.
                                        </div>
                                    </div>
                                </div>
                            </article>

                            <!-- Execution -->
                            <article
                                id="panel-impl"
                                role="tabpanel"
                                aria-labelledby="tab-impl"
                                aria-hidden="true"
                                class="panel"
                            >
                                <h3 class="text-xl font-bold mb-2">
                                    Execution view
                                </h3>
                                <p
                                    class="text-muted-foreground leading-relaxed"
                                >
                                    The technical detail: which services,
                                    automations, and people actually do the
                                    work. Ideal for IT and engineers to verify
                                    what runs where — without losing sight of
                                    the bigger flow.
                                </p>

                                <div
                                    class="mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"
                                >
                                    <div
                                        class="rounded-xl border border-green-500/20 bg-green-500/10 p-4"
                                    >
                                        <div
                                            class="font-semibold text-green-700 dark:text-green-300"
                                        >
                                            Human + System tasks
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            Mix approvals with automated steps,
                                            clearly visible.
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-xl border border-emerald-500/20 bg-emerald-500/10 p-4"
                                    >
                                        <div
                                            class="font-semibold text-emerald-700 dark:text-emerald-300"
                                        >
                                            Guardrails
                                        </div>
                                        <div
                                            class="text-xs text-muted-foreground"
                                        >
                                            Tests, policies, and monitoring
                                            built into the flow.
                                        </div>
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /stage -->
    </div>
</section>

<script type="module">
    (() => {
        const tablist = document.getElementById("layers-tabs");
        if (!tablist) return;

        /** @type {HTMLButtonElement[]} */
        const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));

        const panels = {
            business: document.getElementById("panel-business"),
            data: document.getElementById("panel-data"),
            impl: document.getElementById("panel-impl"),
        };

        const viz = document.getElementById("viz-layers");
        const indicator = document.getElementById("tab-indicator");

        const setActive = (key) => {
            tabs.forEach((t) =>
                t.setAttribute(
                    "aria-selected",
                    String(t.dataset.target === key),
                ),
            );
            Object.entries(panels).forEach(([k, el]) => {
                if (!el) return;
                const active = k === key;
                el.dataset.state = active ? "active" : "inactive";
                el.setAttribute("aria-hidden", String(!active));
            });
            if (viz) viz.setAttribute("data-active", key);

            const activeTab = tabs.find((t) => t.dataset.target === key);
            if (activeTab && indicator) {
                const { offsetLeft, offsetWidth } = activeTab;
                indicator.style.width = `${offsetWidth}px`;
                indicator.style.transform = `translateX(${offsetLeft}px)`;
            }
        };

        const initial =
            tabs.find((t) => t.getAttribute("aria-selected") === "true")
                ?.dataset.target ?? "business";
        setActive(initial);

        tabs.forEach((btn) =>
            btn.addEventListener("click", () => setActive(btn.dataset.target)),
        );

        tablist.addEventListener("keydown", (e) => {
            const i = tabs.findIndex(
                (t) => t.getAttribute("aria-selected") === "true",
            );
            let n = i;
            switch (e.key) {
                case "ArrowRight":
                    n = (i + 1) % tabs.length;
                    break;
                case "ArrowLeft":
                    n = (i - 1 + tabs.length) % tabs.length;
                    break;
                case "Home":
                    n = 0;
                    break;
                case "End":
                    n = tabs.length - 1;
                    break;
                case "Enter":
                case " ":
                    e.preventDefault();
                    setActive(tabs[i].dataset.target);
                    return;
                default:
                    return;
            }
            e.preventDefault();
            tabs[n].focus();
            setActive(tabs[n].dataset.target);
        });

        const ro = new ResizeObserver(() => {
            const active = tabs.find(
                (t) => t.getAttribute("aria-selected") === "true",
            );
            if (active && indicator) {
                indicator.style.width = `${active.offsetWidth}px`;
                indicator.style.transform = `translateX(${active.offsetLeft}px)`;
            }
        });
        ro.observe(tablist);
        tabs.forEach((t) => ro.observe(t));
    })();
</script>

<style>
    /* Stage layout */
    .stage {
        --stage-h: min(56vh, 520px);
    }

    /* Panels: stacked/faded (desktop) */
    .panel {
        position: absolute;
        inset: 0;
        opacity: 0;
        transform: translateY(6px);
        transition:
            opacity 220ms ease,
            transform 220ms ease;
        pointer-events: none;
        padding: 0.5rem;
    }
    .panel[data-state="active"] {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    /* Tabs text color */
    .layers-tab {
        color: color-mix(in oklch, var(--muted-foreground) 82%, transparent);
    }
    .layers-tab[aria-selected="true"] {
        color: var(--foreground);
    }

    /* Viz sizing + highlights */
    #viz-layers {
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
    }
    #viz-layers .plane {
        opacity: 0.33;
        filter: saturate(0.95) brightness(0.98);
    }
    #viz-layers[data-active="business"] [data-k="business"],
    #viz-layers[data-active="data"] [data-k="data"],
    #viz-layers[data-active="impl"] [data-k="impl"] {
        opacity: 1;
        filter: none;
    }

    #viz-layers svg {
        text-rendering: geometricPrecision;
        -webkit-font-smoothing: antialiased;
    }
    #viz-layers .label {
        filter: none;
        paint-order: stroke;
        stroke: rgba(0, 0, 0, 0.55);
        stroke-width: 0.6px;
        font-size: 14px;
    }

    /* Mobile-first compaction */
    @media (max-width: 1023px) {
        .stage .grid {
            grid-template-columns: 1fr;
        }
        #tab-indicator {
            display: none;
        }
        #layers-panels {
            height: auto;
            min-height: 0;
        }

        /* Panels become normal flow; only active is shown */
        .panel {
            position: relative;
            inset: auto;
            opacity: 1;
            transform: none;
            pointer-events: auto;
            display: none;
            padding: 0.25rem;
        }
        .panel[data-state="active"] {
            display: block;
        }

        /* Slightly tighter rhythm */
        #layers [role="tablist"] {
            margin-bottom: 0.25rem;
        }
        #layers p {
            line-height: 1.45;
        }
    }

    @media (max-width: 640px) {
        #layers-tabs {
            gap: 0.25rem;
        }
        .layers-tab {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .layers-tab .tab-label {
            display: none;
        }
        .layers-tab[aria-selected="true"] .tab-label {
            display: inline;
            margin-left: 0.25rem;
        }
        /* Slightly larger touch target for icons */
        .layers-tab [data-icon] {
            width: 2rem;
            height: 2rem;
        }
        /* Hide desktop indicator on mobile (already hidden in markup, this is a safeguard) */
        #tab-indicator {
            display: none !important;
        }
    }

    @media (prefers-reduced-motion: reduce) {
        #tab-indicator,
        .panel {
            transition: none !important;
        }
    }
</style>
